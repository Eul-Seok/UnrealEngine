# PGO (Profile-Guided Optimization)

PGO(Profile-Guided Optimization)는 프로파일링 데이터를 기반으로 컴파일러가 코드를 최적화하는 기법입니다. 실제 애플리케이션 실행 시 수집된 데이터를 활용하여, 최종 빌드(Shipping)에서 더 나은 성능을 이끌어낼 수 있습니다. CPU 사용량이 많은 시나리오에서 PGO를 적용하면 최대 10%까지 성능이 향상될 수 있습니다.

## PGO의 원리

PGO는 다음과 같은 3단계 프로세스로 진행됩니다.

1.  **계측 빌드 (Instrumented Build) 생성**: 코드가 실행될 때 성능 데이터를 수집할 수 있도록 특별한 코드가 추가된 빌드를 생성합니다.
2.  **프로파일 데이터 생성**: 계측 빌드를 실행하여 애플리케이션의 일반적인 사용 시나리오를 재현합니다. 이 과정에서 수집된 데이터는 `.pgd` 형식의 파일로 저장됩니다. 최적화 품질은 이 데이터가 얼마나 실제 사용 사례를 잘 반영하는지에 따라 결정되므로 매우 중요한 단계입니다.
3.  **최적화 빌드 (Optimized Build) 생성**: 프로파일 데이터를 컴파일러에 제공하여 다시 빌드합니다. 컴파일러는 이 데이터를 기반으로 자주 사용되는 함수를 인라이닝하거나, 분기 예측을 개선하고, 코드 레이아웃을 효율적으로 재구성하는 등 정보에 입각한 최적화를 수행합니다.

## 언리얼 엔진에서 PGO 사용하기

### 계측 빌드 (Instrumented Build)

- `Engine/Build/PGO/` 폴더의 스크립트를 실행해 계측용 바이너리를 생성합니다.

- 이 빌드는 실행 시 함수 호출 빈도, 분기 예측, 코드 경로 사용률 같은 데이터를 수집할 수 있도록 계측 코드가 삽입됩니다.

### 프로파일링 데이터 수집

- 계측 빌드를 실행하고, 실제 게임 플레이 시나리오(대표적인 레벨 로딩, 전투, UI 상호작용 등)를 충분히 커버해야 합니다.

    > **참고**: Fortnite 같은 경우 Epic은 리플레이 데이터를 활용해 자동화된 플레이 시뮬레이션으로 PGO 데이터를 수집했다고 알려져 있습니다.

- 플레이 종료 후 `.pgc` 또는 `.pgd` 형태의 프로파일링 데이터가 생성됩니다.

### 최적화 빌드 (PGO Optimize Build)

- 수집된 프로파일링 데이터를 입력으로 다시 빌드합니다.

- 컴파일러는 자주 실행되는 코드 경로를 속도 위주로, 거의 실행되지 않는 경로는 크기 위주로 최적화합니다.

- 결과적으로 실행 파일의 성능이 개선되며, Epic Games 문서에서는 일부 시나리오에서 약 10% 성능 향상이 보고된 바 있습니다.

## 장단점

### 장점

-   **성능 향상**: 다른 최적화 기법을 모두 적용한 후에도 추가적인 성능 향상을 기대할 수 있습니다. 특히 CPU 부하가 큰 게임에 효과적입니다.

### 단점

-   **시간 소모**: 전체 프로세스가 여러 번의 컴파일과 데이터 수집 단계를 포함하므로 시간이 오래 걸립니다.
-   **복잡한 설정**: 특히 구버전 엔진에서는 PGO 설정 과정이 복잡하고 문서화가 부족할 수 있습니다.
-   **데이터 의존성**: 최적화의 효율이 프로파일링 데이터의 품질에 크게 좌우됩니다. 대표성이 없는 데이터는 오히려 성능을 저하시킬 수도 있습니다.

## 최신 동향

언리얼 엔진 5.4부터는 Intel과 협력하여 하드웨어 지원 PGO(Hardware-Assisted PGO) 기능이 도입되었습니다. 이는 기존의 계측 방식보다 오버헤드가 훨씬 적어 더 효율적으로 프로파일링 데이터를 수집할 수 있게 해줍니다.
